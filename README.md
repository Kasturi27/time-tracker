# time-tracker

Be nilenso's time tracking tool.

## Production Installation
Please use Ubuntu 16.04 LTS.

SSH into your box. Ensure that you are root.

First, apt install all the things.
``` bash
apt install nginx npm node git unzip openjdk-8-jdk postgresql
```

Configure nginx.
``` bash
cd /etc/nginx/sites-available/
mv default default.backup
```

Create a file called `default` in `/etc/nginx/sites-available/` with the following
content:
```
##
# You should look at the following URL's in order to grasp a solid understanding
# of Nginx configuration files in order to fully unleash the power of Nginx.
# http://wiki.nginx.org/Pitfalls
# http://wiki.nginx.org/QuickStart
# http://wiki.nginx.org/Configuration
#
# Generally, you will want to move this file somewhere, and start with a clean
# file but keep this around for reference. Or just disable in sites-enabled.
#
# Please see /usr/share/doc/nginx-doc/examples/ for more detailed examples.
##

# Default server configuration
#
server {
	listen 80 default_server;
	listen [::]:80 default_server;

	# SSL configuration
	#
	# listen 443 ssl default_server;
	# listen [::]:443 ssl default_server;
	#
	# Note: You should disable gzip for SSL traffic.
	# See: https://bugs.debian.org/773332
	#
	# Read up on ssl_ciphers to ensure a secure configuration.
	# See: https://bugs.debian.org/765782
	#
	# Self signed certs generated by the ssl-cert package
	# Don't use them in a production server!
	#
	# include snippets/snakeoil.conf;

	root /var/www/;

	# Add index.php to the list if you are using PHP
	index index.html;

	server_name _;

	location /api/timers/ws-connect/ {
		# Websockets tunneling
		proxy_pass http://127.0.0.1:8000;
		proxy_http_version 1.1;
		proxy_set_header Upgrade $http_upgrade;
		proxy_set_header Connection "Upgrade";
	}
	location /api/ {
		# Proxy to backend
		proxy_pass http://127.0.0.1:8000;
	}
	location / {
		# Serve the contents of index.html, no matter what the URL
		try_files $uri /index.html;
	}
}
```

Run
```
nginx -s reload
```

Now, build and deploy the frontend. If you are deploying a branch other than
`master` then be sure to `wget` the correct zip file or `git clone` the correct
branch.

``` bash
wget https://github.com/nilenso/time-tracker-web/archive/master.zip
unzip master.zip
# cd into the source directory
cd time-tracker-web-master/
npm install
# Make sure that REACT_APP_CLIENT_ID is set to your Google client ID
export REACT_APP_CLIENT_ID=your_google_client_id;
nodejs scripts/build.js
cd build
cp -R * /var/www
cd /var/www
rm -rf html/
```

At this point, `nginx` should be serving the frontend. It won't work until
the backend is fully set up.

Create a user to run the backend.
``` bash
adduser --system timetracker
```

Next, create the postgres database.
``` bash
# This will prompt for a password
sudo -u postgres createuser timetracker -P
sudo -u postgres createdb timetracker -O timetracker
```

Clone/download the backend code. Make sure that you are on the branch that you
want to deploy.
``` bash
cd
git clone https://github.com/nilenso/time-tracker.git
cd time-tracker/
git branch desired-branch
git pull
cd
```

The backend is configured using environment variables. Building an uberjar
and running migrations require some of them to be defined. Create a file in your home called
`env.sh` with the following contents (insert your details as necessary):
``` bash
export GOOGLE_TOKENINFO_URL="https://www.googleapis.com/oauth2/v3/tokeninfo";
export CP_MAX_IDLE_TIME_EXCESS_CONNECTIONS="1800";
export CP_MAX_IDLE_TIME="10800";
export DB_CONNECTION_STRING="jdbc:postgresql://localhost/timetracker?user=timetracker&password=your_password_if_any";
export GOOGLE_CLIENT_ID="your_google_client_id";
export APP_LOG_LEVEL="debug";
export PORT="8000";
export ALLOWED_HOSTED_DOMAIN="yourgoogleappsforworkhosteddomain.com";
```

Export these variables:
``` bash
source ./env.sh
```

Install Leiningen to build the project.

``` bash
cd
wget https://raw.githubusercontent.com/technomancy/leiningen/stable/bin/lein
chmod a+x ./lein
export LEIN_ROOT=true
./lein
```

Run the migrations and build the uberjar. You should see an INFO log telling you which migrations were
applied if the environment variables are configured correctly.

``` bash
cd ~/time-tracker
../lein deps
../lein migrate
../lein uberjar
# Substitude this filename with the name of the standalone jar produced.
cp target/uberjar/<standalone-jar-name.jar> /home/timetracker/time-tracker.jar
cd /home/timetracker/
chown timetracker ./time-tracker.jar
```

Create a file here called `start-jar.sh` with the following contents. Substitute
your details as necessary.
``` bash
export GOOGLE_TOKENINFO_URL="https://www.googleapis.com/oauth2/v3/tokeninfo";
export CP_MAX_IDLE_TIME_EXCESS_CONNECTIONS="1800";
export CP_MAX_IDLE_TIME="10800";
export DB_CONNECTION_STRING="jdbc:postgresql://localhost/timetracker?user=timetracker&password=your_password_if_any";
export GOOGLE_CLIENT_ID="your_google_client_id";
export APP_LOG_LEVEL="debug";
export PORT="8000";
export ALLOWED_HOSTED_DOMAIN="yourgoogleappsforworkhosteddomain.com";
java -jar $1;
```

Finally, start the uberjar as `timetracker`.
``` bash
chmod 755 ./start-jar.sh
sudo -u timetracker ./start-jar.sh time-tracker.jar >> logs.txt &
```

You may `tail -f /home/timetracker/logs.txt` to view the logs.

## License

Copyright Â© 2016

Distributed under the Eclipse Public License either version 1.0 or (at
your option) any later version.
